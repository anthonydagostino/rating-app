@page "/rate"
@attribute [Authorize]

<PageTitle>Discover - RatingApp</PageTitle>

@if (_matchMessage is not null)
{
    <div class="match-overlay">
        <div class="match-card">
            <h2>It's a Match!</h2>
            <p>@_matchMessage</p>
            <a href="/chats" class="btn-match-action">Send a Message</a>
        </div>
    </div>
}

<div class="rate-page">
    @if (_loading)
    {
        <div class="empty-state">
            <div class="spinner-border" style="color:#FD297B" role="status"></div>
            <p style="margin-top:1rem;color:var(--muted)">Finding people near you...</p>
        </div>
    }
    else if (_current is null)
    {
        <div class="empty-state">
            <i class="bi bi-search-heart" style="font-size:3rem;color:#E0E0E0"></i>
            <h3 style="margin-top:1rem">No one nearby right now</h3>
            <p>Check back later or adjust your <a href="/profile">preferences</a>.</p>
            <button class="btn-tinder" style="display:inline-block;margin-top:1rem;padding:0.75rem 2rem" @onclick="Reload">Refresh</button>
        </div>
    }
    else
    {
        <div class="candidate-card">
            @{
                var photos = _current.PhotoUrls ?? new List<string>();
                bool hasPhotos = photos.Count > 0;
            }

            @if (hasPhotos)
            {
                <div class="photo-carousel">
                    <img class="carousel-img" src="@photos[_photoIndex]" alt="@_current.DisplayName" />

                    @if (photos.Count > 1)
                    {
                        <div class="carousel-dots">
                            @for (int i = 0; i < photos.Count; i++)
                            {
                                var idx = i;
                                <span class="carousel-dot @(idx == _photoIndex ? "active" : "")"
                                      @onclick="() => _photoIndex = idx"></span>
                            }
                        </div>

                        @if (_photoIndex > 0)
                        {
                            <button class="carousel-btn carousel-btn-left" @onclick="PrevPhoto">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        }
                        @if (_photoIndex < photos.Count - 1)
                        {
                            <button class="carousel-btn carousel-btn-right" @onclick="NextPhoto">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        }
                    }
                </div>
            }
            else
            {
                <div class="candidate-avatar">@_current.DisplayName[0]</div>
            }

            <div class="candidate-card-body">
                <div class="candidate-name">@_current.DisplayName</div>
                <div class="candidate-tags">
                    <span class="candidate-tag">@_current.Age years old</span>
                    <span class="candidate-tag"><i class="bi bi-geo-alt-fill"></i> @_current.DistanceMiles mi away</span>
                </div>
            </div>
        </div>

        <div class="rating-card">
            @if (_criteria.Count == 0)
            {
                <p style="color:var(--muted);text-align:center">Loading criteria...</p>
            }
            else
            {
                @foreach (var criterion in _criteria)
                {
                    var score = _criteriaScores[criterion.Id];
                    <div class="criterion-row" style="margin-bottom:1rem">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem">
                            <span class="criterion-name" style="font-weight:600;font-size:0.95rem">
                                @criterion.Name
                                @if (criterion.IsRequired)
                                {
                                    <span style="color:#FD297B;margin-left:2px">*</span>
                                }
                            </span>
                            <span class="criterion-score-badge" style="font-weight:700;color:#FD297B;min-width:1.5rem;text-align:right">
                                @score
                            </span>
                        </div>
                        <input type="range" class="tinder-range" min="1" max="10" step="1"
                               value="@score"
                               @onchange="e => OnCriterionScoreChanged(criterion.Id, e.Value!.ToString()!)" />
                        <div class="rating-range-labels" style="font-size:0.75rem">
                            <span>Not interested</span>
                            <span>Perfect match</span>
                        </div>
                    </div>
                }

                <div class="aggregate-preview" style="margin-top:1.25rem;padding:0.75rem 1rem;background:rgba(253,41,123,0.06);border-radius:12px;display:flex;align-items:center;justify-content:space-between">
                    <span style="font-size:0.9rem;color:var(--muted)">Weighted score</span>
                    <span style="font-size:1.4rem;font-weight:700;color:#FD297B">@_liveAggregate.ToString("F1")</span>
                </div>

                <div style="margin-top:1rem">
                    <textarea class="form-control" placeholder="Add a comment (optional, max 500 chars)"
                              maxlength="500" rows="2"
                              style="resize:none;border-radius:10px;font-size:0.9rem"
                              @bind="_comment"></textarea>
                </div>
            }
        </div>

        <div class="action-row">
            <button class="action-btn-skip" @onclick="Skip" title="Skip">
                <i class="bi bi-x-lg"></i>
            </button>
            <button class="action-btn-rate" @onclick="SubmitRating" disabled="@(_submitting || _criteria.Count == 0)">
                <i class="bi bi-heart-fill"></i>
                @(_submitting ? "Rating..." : $"Rate {_liveAggregate:F1}/10")
            </button>
        </div>

        @if (_queue.Count > 0)
        {
            <p style="text-align:center;color:var(--muted);font-size:0.8rem;margin-top:1rem">
                @_queue.Count more in queue
            </p>
        }
    }
</div>

@code {
    [Inject] private CandidateApiService CandidateService { get; set; } = default!;
    [Inject] private RatingApiService RatingService { get; set; } = default!;

    private readonly Queue<CandidateDto> _queue = new();
    private CandidateDto? _current;
    private int _photoIndex = 0;
    private bool _loading = true;
    private bool _submitting;
    private string? _matchMessage;
    private bool _allLoaded;

    private List<CriterionModel> _criteria = new();
    private Dictionary<Guid, int> _criteriaScores = new();
    private string? _comment;

    private double _liveAggregate => ComputeAggregate();

    protected override async Task OnInitializedAsync()
    {
        _criteria = await RatingService.GetCriteriaAsync();
        ResetScores();

        await LoadMoreCandidates(showLoading: true);
        Advance();
    }

    private void ResetScores()
    {
        _criteriaScores = _criteria.ToDictionary(c => c.Id, _ => 7);
        _comment = null;
    }

    private void OnCriterionScoreChanged(Guid criterionId, string rawValue)
    {
        if (int.TryParse(rawValue, out var score))
            _criteriaScores[criterionId] = score;
    }

    private double ComputeAggregate()
    {
        if (_criteria.Count == 0) return 0;
        double totalWeight = _criteria.Sum(c => c.Weight);
        if (totalWeight == 0) return 0;
        double weighted = _criteria.Sum(c => _criteriaScores.TryGetValue(c.Id, out var s) ? s * c.Weight : 0);
        return Math.Round(weighted / totalWeight, 1);
    }

    private async Task LoadMoreCandidates(bool showLoading = false)
    {
        if (showLoading) _loading = true;
        try
        {
            var candidates = await CandidateService.GetCandidatesAsync(pageSize: 10) ?? new();
            foreach (var c in candidates)
                _queue.Enqueue(c);
            if (!candidates.Any()) _allLoaded = true;
        }
        catch { _allLoaded = true; }
        _loading = false;
    }

    private void Advance()
    {
        _current = _queue.Count > 0 ? _queue.Dequeue() : null;
        _photoIndex = 0;
        ResetScores();

        if (_queue.Count <= 2 && !_allLoaded)
            _ = LoadMoreCandidates();
    }

    private void PrevPhoto()
    {
        if (_photoIndex > 0) _photoIndex--;
    }

    private void NextPhoto()
    {
        var count = _current?.PhotoUrls?.Count ?? 0;
        if (_photoIndex < count - 1) _photoIndex++;
    }

    private async Task SubmitRating()
    {
        if (_current is null || _criteria.Count == 0) return;
        _submitting = true;

        var criteriaScores = _criteria
            .Select(c => new CriterionScoreModel(c.Id, _criteriaScores[c.Id]))
            .ToList();

        var result = await RatingService.SubmitRatingAsync(_current.UserId, criteriaScores, _comment);

        if (result?.MatchCreated == true)
        {
            _matchMessage = $"You and {_current.DisplayName} both rated each other highly!";
            _ = ClearMatchMessageAfterDelay();
        }

        Advance();
        _submitting = false;
    }

    private void Skip() => Advance();

    private async Task Reload()
    {
        _allLoaded = false;
        _queue.Clear();
        await LoadMoreCandidates(showLoading: true);
        Advance();
    }

    private async Task ClearMatchMessageAfterDelay()
    {
        await Task.Delay(5000);
        _matchMessage = null;
        StateHasChanged();
    }
}